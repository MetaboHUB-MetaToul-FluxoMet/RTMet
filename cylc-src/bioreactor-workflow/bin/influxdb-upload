#!/usr/bin/env python3

import os
import argparse
from pathlib import Path

import influx_utils

BUCKET_NAME = os.getenv("BUCKET_NAME", "no_bucket_name_given")


def main():
    parser = argparse.ArgumentParser(
        prog="influxdb-upload", description="Upload CSV to InfluxDB."
    )
    parser.add_argument("--table", type=str, help="Table name to ingest.")
    parser.add_argument("--dir", type=Path, help="Path to directory with CSV tables.")
    parser.add_argument(
        "--schemas", type=Path, help="Path to JSON with tables schemas."
    )

    args = parser.parse_args()
    schemas = influx_utils.load_tables_schemas(args.schemas)
    measurement_df = influx_utils.measurement_df_from_csv(schemas, args.table, args.dir)
    client = influx_utils.client_from_env()
    influx_utils.ingest(measurement_df, client, bucket=BUCKET_NAME)


if __name__ == "__main__":
    main()
